{% extends 'base.html' %}

{% block links %}
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <style>
        .stats-chart {
            height: 400px;
            width: 400px;
        }
    </style>

    <div class="container mt-5">
        <h1 class=" text-align-center mt-60 mb-60">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ request.user.username }}</h1>

        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –ì—Ä–∞—Ñ–∏–∫ Doughnut -->
        <div class="row">
            <div class="col-md-4">
                <div class="stats-chart">
                    <canvas id="totalStatsChart" width="400" height="400"></canvas>
                </div>

            </div>
            <div class="col-md-4">
                <div class="card text-center shadow rounded-4 border-0 bg-light">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-4 text-primary">
                            <i class="bi bi-bar-chart-line-fill me-2"></i>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </h5>
                        <div class="d-flex flex-column gap-3">
                            <div class="stat-item">
                                <span class="text-muted">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –∫—É—Ä—Å–µ:</span><br>
                                <span class="fs-5 fw-semibold text-dark">{{ total_questions_in_course }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="text-success">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</span><br>
                                <span class="fs-5 fw-semibold">{{ correct_answers_total }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="text-danger">‚úò –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</span><br>
                                <span class="fs-5 fw-semibold">{{ incorrect_answers_total }}</span>
                            </div>
                            <hr>
                            <div class="stat-item">
                                <span class="text-muted">–¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:</span><br>
                                <span class="fs-4 fw-bold">{{ correct_percentage }}%</span>
                            </div>
                            <div class="stat-item">
                                {% if correct_percentage >= 80 %}
                                    <span class="badge bg-success fs-6 px-3 py-2 mt-2">üéâ –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç!</span>
                                {% else %}
                                    <span class="text-muted">–î–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å:</span><br>
                                    <span class="fs-5 fw-semibold text-primary">{{ remaining_to_cert }}%</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <a href="{% url 'course_detail' cours_id %}" class="btn btn-secondary">
                    Return To Course
                </a>
                <a href="{% url 'test_models' cours_id %}" class="btn btn-outline-secondary">
                    Return To Tests
                </a>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥—É–ª—è–º - –¢–∞–±–ª–∏—Ü–∞ —Å —Ü–∏—Ñ—Ä–∞–º–∏ -->
        <h2 class="mt-5 mb-4 text-primary fw-bold">
            <i class="bi bi-clipboard-data-fill me-2 green-text"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥—É–ª—è–º
        </h2>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle shadow-sm rounded-3 overflow-hidden">
                <thead class="table-primary text-center">
                <tr class="fw-semibold">
                    <th style="width: 40%;">–ú–æ–¥—É–ª—å</th>
                    <th style="width: 30%;">‚úî –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ</th>
                    <th style="width: 30%;">‚úò –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</th>
                </tr>
                </thead>
                <tbody class="bg-white text-center">
                {% for module_id, stats in module_stats.items %}
                    <tr>
                        <td class="fw-medium text-start ps-4">{{ stats.module_title }}</td>
                        <td class="text-success fw-semibold">{{ stats.correct_answers }}</td>
                        <td class="text-danger fw-semibold">{{ stats.incorrect_answers }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ—Å—Ç–∞—Ö.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Doughnut Chart –¥–ª—è –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const totalStatsCtx = document.getElementById('totalStatsChart').getContext('2d');
        new Chart(totalStatsCtx, {
            type: 'doughnut',
            data: {
                labels: ['–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã', '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã'],
                datasets: [{
                    label: '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                    data: [{{ correct_answers_total }}, {{ incorrect_answers_total }}],
                    backgroundColor: ['#28a745', '#dc3545'],
                    hoverOffset: 4
                }]
            }
        });
    </script>
{% endblock %}